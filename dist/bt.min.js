!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).bt=t()}(this,function(){"use strict";const e={},t={},i={searchTimeout:6e4,searchInterval:4e3,filterDevices:e=>e,getUid:e=>e.deviceId,canAdd2DeivceMap:()=>!0,changeToValue:e=>e,changeBackValue:e=>e},n=-1,o=0,c=1;let r="";function s(e){if(e)return function(e){for(var t in s.prototype)e[t]=s.prototype[t];return e}(e)}function a({uid:e,deviceId:t}){var i;this._deviceId=t,this._uid=e,this._data=null,(i=this).deviceWR=null,i._writeQueue=[],function(e){e._connect=n,e._writing=!1,e._writeTimes=0}(this),function(e){e._listeners=Object.create(null)}(this)}s.prototype.on=function(e,t){const i=this(i._listeners[e]||(i._listeners[e]=[])).push(t);return i},s.prototype.off=function(e,t){const i=this;if(arguments.length)if(t){const o=i._listeners[e]||(i._listeners[e]=[]);for(var n=o.length;n--;){const e=o[n];if(e===t||e.fn===t){o.splice(n,1);break}}}else i._listeners[e]=null;else i._listeners=Object.create(null);return i},s.prototype.trigger=function(e){const t=this._listeners[e]||(this._listeners[e]=[]);let i;for(var n=t.length;n--;){if(!1===(i=t[n]([].slice.call(arguments,1)))&&1===devs.length)return!1;if(!1===i)break}return this},s.prototype.once=function(e,t){const i=this;function n(){i.off(e,n),t.apply(i,arguments)}return n.fn=t,i.on(e,n),i},a.prototype.setDeviceId=function(e){this._deviceId=e},a.prototype.setData=function(e){this._data=e},function(e){e.prototype.connect=function(){var e,t,i;this.isUnConnected()&&this._deviceId&&(this.startConnect(),e=this._deviceId,t=(()=>{this.changeConnectState(!0),this._write()}),i=(()=>{this.changeConnectState(!1),this.trigger("connectFail")}),wx.createBLEConnection({deviceId:e,success:()=>{t()},fail:e=>{10001===e.errCode&&g(),i()}}))},e.prototype.getService=function(){var e;e=this._deviceId,wx.getBLEDeviceServices({deviceId:e,success:({services:t})=>{const i=t.length;for(let n=0;n<i;n++){const i=t[n];if(i.isPrimary&&1===n){d(i.uuid,e);break}}},fail:e=>{console.log("getBLEDeviceServices fail",JSON.stringify(e))}})},e.prototype.canWrite=function(e){this.deviceWR=e,this.trigger("ready")},e.prototype.write=function(){if(this.isUnConnected()&&this.connect(),this._writeTimes>255)return console.error("write too many times!"),void wx.closeBLEConnection({deviceId:deviceId});this._writeQueue.push([].slice(arguments,0)),this._write()},e.prototype._write=function(){if(this.isConnected()&&!this._writing&&this._writeQueue.length){const e=i.changeToValue(this._writeQueue[0]);this._subWrite(function(e){if("string"!=typeof e)throw new TypeError("Expected input to be a string");if(e.length%2!=0)throw new RangeError("Expected string to be an even number of characters");let t=new Uint8Array(e.length/2);for(let i=0,n=0;i<e.length;i+=2,n++)t[i/2]=parseInt(e.substring(i,i+2),16);return t.buffer}(e))}},e.prototype._subWrite=function({buffer:e,length:t}){const i=e.slice(0,30);this._isWriting=!0,wx.writeBLECharacteristicValue({...this.deviceWR,value:i,success:()=>{t>30?function(e){r?e("ios"===r):wx.getSystemInfo({success:t=>{r=t.platform,e("ios"===r)}})}(i=>{const n={buffer:e.slice(30),length:t-30};i?this._subWrite(n):setTimeout(()=>{this._subWrite(n)},250)}):setTimeout(()=>{this._isWriting=!1,this._qWrite()},300)},fail:i=>{console.log("writeBLECharacteristicValue fail",i.errMsg),this._subWrite({buffer:e,length:t})}})}}(a),function(e){e.prototype.changeConnectState=function(e){const t=this._connect;e&&t!==c?(this._connect=c,this.trigger("connect")&&this.getService()):e||t===n||(dev._connect=n,dev._writeTimes=0,this.trigger("disconnect"))},e.prototype.startConnect=function(){this._connect=o},e.prototype.isConnected=function(){return this._connect===c},e.prototype.isUnConnected=function(){return this._connect===n}}(a),function(e){s(e.prototype)}(a);let l=!1,u=!1,h=null;function f(){l||(wx.openBluetoothAdapter({success:e=>{console.log("openBluetoothAdapter success",e)},fail:e=>{console.log("openBluetoothAdapter fail",e),p.trigger("fail","开启蓝牙失败",1),10001===e.errCode?g():wx.showToast({icon:"none",title:e.errMsg||"开启蓝牙失败"})}}),function(){wx.onBluetoothDeviceFound(({devices:n})=>{if(!u)return;const o=(n=i.filterDevice(n)).length;for(let c=0;c<o;c++){const o=n[c],r=o.deviceId;if(!e[r]&&i.canAdd2DeivceMap(o)){const n=i.getUid(o);let c=null;t[n]?(c=t[n]).setDeviceId(r):(c=new a({uid:n,deviceId:r}),t[n]=c),e[r]=c,c.trigger("find")}}}),wx.onBLEConnectionStateChange(({deviceId:t,connected:i})=>{const n=e[t];n&&n.changeConnectState(i)}),wx.onBluetoothAdapterStateChange(e=>{console.log("onBluetoothAdapterStateChange",e),e.available&&(this.available=!0),e.available&&e.discovering&&this.listenChange&&(this.listenChange=!1,this._startBluetoothDevicesDiscovery())}),wx.onBLECharacteristicValueChange(({value:t,deviceId:n})=>{const o=e[n];if(!o)return;const c=function(e){if("object"!=typeof e||null===e||"number"!=typeof e.byteLength)throw new TypeError("Expected input to be an ArrayBuffer");for(var t,i=new Uint8Array(e),n="",o=0;o<i.length;o++)n+=1===(t=i[o].toString(16)).length?"0"+t:t;return n}(t);o.trigger("msg",i.changeBackValue(c))})}(),l=!0)}function d(t,i){wx.getBLEDeviceCharacteristics({deviceId:i,serviceId:t,success:({characteristics:n})=>{const o=n.length;let c=null,r=!1;for(let e=0;e<o;e++){let o=n[e];o.properties.write&&(c={deviceId:i,serviceId:t,characteristicId:o.uuid}),(o.properties.notify||o.properties.indicate)&&(r=!0,wx.notifyBLECharacteristicValueChange({deviceId:i,serviceId:t,characteristicId:o.uuid,state:!0}))}if(c&&r){e[i].canWrite(c)}else console.log("?")},fail(e){console.error("getBLEDeviceCharacteristics",e)}})}function g(){wx.showModal({content:"手机蓝牙尚未开启，请在系统设置或快捷方式中打开手机蓝牙。",confirmText:"立即开启",cancelText:"稍后再说",success(e){e.confirm?this.listenChange=!0:e.cancel&&(this.listenChange=!1,p.trigger("cancel",null,1))}})}function p(e){var t;null!==(t=e)&&"object"==typeof t&&Object.keys(i).forEach(t=>{e.hasOwnProperty(t)&&(i[t]=e[t])}),f()}return p.get=function(){if(arguments.length){const e=arguments[0];if(t[e])return t[e];{const n=new a({uid:e});return t[e]=n,u||(wx.startBluetoothDevicesDiscovery({allowDuplicatesKey:!0,interval:i.searchInterval,success:()=>{u=!0},fail:e=>{10001===e.errCode&&g(),console.log("startBluetoothDevicesDiscovery fail",e)}}),i.searchTimeout&&(clearTimeout(h),h=setTimeout(()=>{u&&(p.trigger("timeout"),function(){u&&(clearTimeout(this.timeId),wx.stopBluetoothDevicesDiscovery({success:()=>{u=!1}}))}())},i.searchTimeout))),n}}},p.options=i,p.devicesMap=e,p.devicesIdMap=t,p._listeners=Object.create(null),s(p),p});